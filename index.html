<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DPA Market Intelligence Search</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* General Reset & Body */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 30px 30px;
            animation: float 20s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        /* Main Content Sections */
        .main-content {
            padding: 40px;
        }

        .search-section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Predefined Queries */
        .predefined-queries {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .query-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .query-card-content {
            flex-grow: 1;
        }

        .query-card-actions {
            margin-top: 12px;
            display: flex;
            justify-content: flex-end;
        }

        .edit-btn-card {
            background: transparent;
            color: #4a5568;
            border: none;
            border-radius: 8px; /* Rounded square */
            width: 30px; /* Slightly larger */
            height: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 4px;
        }
        .edit-btn-card:hover {
            background: #e2e8f0; /* Light gray hover */
            color: #2d3748;
        }


        .query-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .query-card:hover::before {
            transform: scaleX(1);
        }

        .query-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            border-color: #667eea;
        }

        .query-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
        }

        .query-card.selected::before {
            transform: scaleX(1);
        }

        .query-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .query-purpose {
            color: #718096;
            font-size: 0.9rem;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .query-text {
            background: #f7fafc;
            padding: 12px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.8rem;
            color: #4a5568;
            border-left: 4px solid #667eea;
            max-height: 60px;
            overflow-y: auto; /* Changed from hidden to auto */
            position: relative;
        }

        /* Custom Query & Period Sections */
        .custom-query-section, .period-section {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }

        /* Form Elements */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-weight: 600; color: #2d3748; margin-bottom: 8px; }
        .form-input, .form-textarea, .form-select {
            width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0;
            border-radius: 12px; font-size: 1rem; transition: all 0.3s ease; background: white;
        }
        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }
        .form-textarea { min-height: 100px; resize: vertical; }

        /* Period Options */
        .period-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .period-btn {
            padding: 12px 20px; border: 2px solid #e2e8f0; border-radius: 12px;
            background: white; color: #4a5568; font-weight: 500; cursor: pointer;
            transition: all 0.3s ease; text-align: center;
        }
        .period-btn:hover { border-color: #667eea; background: #f7fafc; }
        .period-btn.active { background: #667eea; color: white; border-color: #667eea; }
        .date-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }

        /* Search Button */
        .search-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;
            padding: 16px 40px; border-radius: 12px; font-size: 1.1rem; font-weight: 600;
            cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center;
            gap: 10px; margin: 30px auto 0; min-width: 200px; justify-content: center;
        }
        .search-button:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102,126,234,0.3); }
        .search-button:active { transform: translateY(0); }

        /* Selected Queries Display */
        .selected-queries { background: #f7fafc; border-radius: 12px; padding: 20px; margin-top: 20px; }
        .selected-query-item {
            background: white; padding: 12px 16px; border-radius: 8px; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .selected-query-item-content { flex-grow: 1; margin-right: 10px; }
        .selected-query-item-actions { display: flex; align-items: center; }

        .edit-btn, .remove-query { /* Common styling for small action buttons */
            border: none; border-radius: 50%; width: 28px; height: 28px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: background-color 0.2s ease;
        }
        .edit-btn { background: #e0e7ff; color: #4f46e5; margin-left: auto; margin-right: 8px; }
        .edit-btn:hover { background: #c7d2fe; }
        .remove-query { background: #fee2e2; color: #dc2626; }
        .remove-query:hover { background: #fecaca; }
        
        /* Modal Styles */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);
            align-items: center; justify-content: center; padding:20px;
        }
        .modal-content {
            background-color: #fff; margin: auto; padding: 30px; border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2); width: 90%; max-width: 600px;
            animation: slideDownModal 0.3s ease-out;
        }
        @keyframes slideDownModal {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .modal .section-title { margin-top:0; margin-bottom: 25px; }
        .modal .form-textarea { min-height: 120px; }
        .modal-actions { margin-top: 25px; display: flex; justify-content: flex-end; gap: 10px; }

        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #667eea;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .predefined-queries { grid-template-columns: 1fr; }
            .date-inputs { grid-template-columns: 1fr; }
            .period-options { grid-template-columns: repeat(2, 1fr); }
            .modal-content { width: 95%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>DPA Market Intelligence</h1>
            <p>Strategic Search Interface for Financial Analytics Insights</p>
        </div>

        <div class="main-content">
            <div class="search-section">
                <h2 class="section-title">
                    <i data-lucide="search"></i> Predefined Search Queries
                </h2>
                <div class="predefined-queries" id="predefinedQueries"></div>
            </div>

            <div class="custom-query-section">
                <h2 class="section-title"> <i data-lucide="edit-3"></i> Custom Query </h2>
                <div class="form-group">
                    <label class="form-label">Query Title</label>
                    <input type="text" class="form-input" id="customTitle" placeholder="Enter a descriptive title for your query">
                </div>
                <div class="form-group">
                    <label class="form-label">Search Query</label>
                    <textarea class="form-textarea" id="customQuery" placeholder="Enter your custom Google search query..."></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button onclick="addCustomQuery()" class="search-button" style="flex-grow: 1; padding: 10px 20px; font-size: 0.9rem;">
                        <i data-lucide="plus"></i> Add Custom Query
                    </button>
                </div>
            </div>

            <div class="period-section">
                <h2 class="section-title"> <i data-lucide="calendar"></i> Time Period </h2>
                <div class="period-options">
                    <button class="period-btn" onclick="setPeriod(this, '24h')">Last 24 Hours</button>
                    <button class="period-btn" onclick="setPeriod(this, 'week')">Past Week</button>
                    <button class="period-btn active" onclick="setPeriod(this, 'month')">Past Month</button>
                    <button class="period-btn" onclick="setPeriod(this, '3months')">Past 3 Months</button>
                    <button class="period-btn" onclick="setPeriod(this, '6months')">Past 6 Months</button>
                    <button class="period-btn" onclick="setPeriod(this, 'year')">Past Year</button>
                    <button class="period-btn" onclick="setPeriod(this, 'custom')">Custom Range</button>
                </div>
                <div class="date-inputs" id="customDateInputs" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">From Date</label>
                        <input type="date" class="form-input" id="fromDate">
                    </div>
                    <div class="form-group">
                        <label class="form-label">To Date</label>
                        <input type="date" class="form-input" id="toDate">
                    </div>
                </div>
            </div>

            <div class="selected-queries" id="selectedQueriesContainer" style="display: none;">
                <h3 style="margin-bottom: 15px; color: #2d3748;">Selected Queries</h3>
                <div id="selectedQueriesList"></div>
            </div>

            <div style="display: flex; gap: 15px; margin-top: 30px; justify-content: center;">
                <button class="search-button" onclick="executeSearch()">
                    <i data-lucide="external-link"></i> Search Google News
                </button>
            </div>
        </div>
    </div>

    <div id="editQueryModal" class="modal">
        <div class="modal-content">
            <h2 class="section-title" id="editModalTitle"><i data-lucide="edit-2" style="margin-right: 8px;"></i>Edit Query</h2>
            <div class="form-group">
                <label class="form-label">Query Title</label>
                <input type="text" class="form-input" id="editQueryTitleInput">
            </div>
            <div class="form-group">
                <label class="form-label">Search Query</label>
                <textarea class="form-textarea" id="editQueryTextInput" style="min-height:150px;"></textarea>
            </div>
            <input type="hidden" id="editQueryIndexInput">
            <input type="hidden" id="editQuerySourceInput"> 
            <div class="modal-actions">
                <button onclick="closeEditModal()" class="period-btn" style="background-color: #e2e8f0; border-color: #cbd5e1;">Cancel</button>
                <button onclick="saveEditedQuery()" class="search-button" style="margin:0; min-width: 120px;">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        // Array of predefined search queries
        const predefinedQueries = [
            {
                title: "Direct Company News",
                purpose: "To find news specifically about Decimal Point Analytics, including updates, partnerships, and M&A.",
                query: '"Decimal Point Analytics" news'
            },
            {
                title: "Financial Services & Digital Transformation",
                purpose: "To track news on FinTech, digital transformation, AI, and innovation in financial services.",
                query: '(FinTech OR "financial services" OR "wealth management" OR "asset management" OR "investment banking") (AI OR "data analytics" OR "digital transformation" OR innovation OR outlook) -jobs -careers -course'
            },
            {
            title: "AI, ML & Data Analytics in Finance",
            purpose: "To monitor trends, applications, and disruptions related to AI, Machine Learning, and Data Analytics in the finance sector.",
            query: '(AI OR "artificial intelligence" OR "machine learning" OR ML OR "data analytics") (finance OR banking OR "financial services") (trend OR application OR solution OR disruption OR report) -definition -tutorial'
            },
            {
                title: "ESG (Environmental, Social, Governance) in Finance",
                purpose: "To find information on ESG trends, regulatory updates, and reporting standards in finance and investments.",
                query: '(ESG OR "sustainable finance") (investment OR banking OR "asset management" OR "financial services") (trends OR "regulatory updates" OR "reporting standards" OR "impact investing")'
            },
            {
                title: "Blockchain & Tokenization in Finance",
                purpose: "To track trends, regulation, and adoption of tokenization, blockchain, and digital assets in finance and capital markets.",
                query: '(tokenization OR blockchain OR "digital assets" OR DLT) (finance OR "capital markets" OR banking OR securities) (trend OR regulation OR adoption OR "use case") -cryptocurrency -NFTs'
            },
            {
                title: "Financial Regulations & Compliance Tech",
                purpose: "To monitor news on financial data regulation, fintech compliance, data privacy, and RegTech solutions.",
                query: '("fintech regulation" OR "fintech compliance" OR "financial technology regulation" OR "financial technology compliance")'
            },
            {
                title: "Talent & Workforce in Finance Tech",
                purpose: "To understand talent shortages, demand, and trends for AI and data science roles in the finance and fintech sectors.",
                query: '("AI talent" OR "data science hiring") (finance OR "financial services" OR fintech) (shortage OR demand OR trend)'
            },
            {
                title: "Competitor & Market Landscape (General)",
                purpose: "To get insights into the general market landscape for financial analytics, AI solutions, and data science providers.",
                query: '("financial analytics" OR "AI solutions" OR "data science" OR "machine learning") (company OR provider OR firm OR leader OR innovation OR startup OR report OR trend) (finance OR "wealth management" OR "asset management" OR banking OR "capital markets") -jobs -careers -course -tutorial -definition'
            },
            {
                title: "Regional Market Growth/Challenges",
                purpose: "To find news on FinTech growth, challenges, investments, and outlook in key regions like India, US, and UK.",
                query: '(FinTech OR "financial technology") (India OR US OR UK) (growth OR challenge OR investment OR outlook) news'
            },
            {
                title: "DPA Competitors",
                purpose: "Keep eye on news of competitors from same industry ",
                query: '"Fractal Analytics" OR "SG Analytics" OR "Tiger Analytics" OR "LatentView Analytics" OR "Mu Sigma"'
            },

        ];

        let selectedQueries = [];
        let selectedPeriod = 'month';

        /**
         * Renders the predefined search queries into the 'predefinedQueries' container.
         * Each query is presented as a clickable card.
         */
        function renderPredefinedQueries() {
            const container = document.getElementById('predefinedQueries');
            container.innerHTML = predefinedQueries.map((pq, index) => `
                <div class="query-card" onclick="event.target.closest('.edit-btn-card') || toggleQuery(${index})">
                    <div class="query-card-content">
                        <div class="query-title">${pq.title}</div>
                        <div class="query-purpose">${pq.purpose}</div>
                        <div class="query-text">${pq.query}</div>
                    </div>
                    <div class="query-card-actions">
                        <button class="edit-btn-card" title="Edit Predefined Query" onclick="openEditModal(${index}, 'predefined')">
                            <i data-lucide="edit-3" style="width:18px; height:18px;"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            syncPredefinedCardsSelectionState(); // Update selection state after rendering
            lucide.createIcons(); // Initialize Lucide icons
        }

        /**
         * Synchronizes the 'selected' class on predefined query cards based on `selectedQueries` array.
         */
        function syncPredefinedCardsSelectionState() {
            const cards = document.querySelectorAll('#predefinedQueries .query-card');
            predefinedQueries.forEach((pq, index) => {
                if (cards[index]) { // Ensure card exists
                    // Check if this predefined query (by its original title) is in selectedQueries and is not a custom edit
                    const isSelectedAsNonCustom = selectedQueries.some(
                        sq => sq.predefinedOriginalTitle === pq.title && !sq.isCustom
                    );
                    if (isSelectedAsNonCustom) {
                        cards[index].classList.add('selected');
                    } else {
                        cards[index].classList.remove('selected');
                    }
                }
            });
        }

        /**
         * Toggles the selection state of a predefined query.
         * If already selected, it's removed; otherwise, it's added.
         * @param {number} predefinedIndex - The index of the predefined query in the `predefinedQueries` array.
         */
        function toggleQuery(predefinedIndex) {
            const predefinedQuery = predefinedQueries[predefinedIndex];
            // Find if this specific predefined query instance is already selected
            const existingSelectedIndex = selectedQueries.findIndex(
                sq => sq.predefinedOriginalTitle === predefinedQuery.title && !sq.isCustom
            );

            if (existingSelectedIndex > -1) {
                // If found, remove it
                selectedQueries.splice(existingSelectedIndex, 1);
            }
            else {
                // If not found, add it as a new, non-custom selected query
                selectedQueries.push({
                    title: predefinedQuery.title,
                    purpose: predefinedQuery.purpose,
                    query: predefinedQuery.query,
                    predefinedOriginalTitle: predefinedQuery.title, // Link to original template
                    isCustom: false // It's a clean instance of a predefined query
                });
            }
            updateSelectedQueriesDisplay(); // Update the display of selected queries
            syncPredefinedCardsSelectionState(); // Update the visual state of predefined cards
        }
        
        /**
         * Adds a custom query to the `selectedQueries` array.
         * Validates input fields before adding.
         */
        function addCustomQuery() {
            const title = document.getElementById('customTitle').value.trim();
            const queryText = document.getElementById('customQuery').value.trim();
            
            if (!title || !queryText) {
                // Use a custom message box instead of alert
                showMessageBox('Please enter both title and query for your custom search.', 'Warning');
                return;
            }
            
            selectedQueries.push({ title, query: queryText, purpose: 'User-defined custom query', isCustom: true });
            
            // Clear input fields
            document.getElementById('customTitle').value = '';
            document.getElementById('customQuery').value = '';
            
            updateSelectedQueriesDisplay();
            syncPredefinedCardsSelectionState(); // In case a custom query has same title as a predefined one by chance
        }

        /**
         * Updates the display of currently selected queries in the 'selectedQueriesList' container.
         * Shows/hides the container based on whether there are selected queries.
         */
        function updateSelectedQueriesDisplay() {
            const container = document.getElementById('selectedQueriesContainer');
            const list = document.getElementById('selectedQueriesList');
            
            if (selectedQueries.length === 0) {
                container.style.display = 'none';
                list.innerHTML = '';
                return;
            }
            
            container.style.display = 'block';
            list.innerHTML = selectedQueries.map((sq, index) => `
                <div class="selected-query-item">
                    <div class="selected-query-item-content">
                        <strong>${sq.title} ${sq.isCustom ? '<span style="font-size:0.7rem; color:#764ba2;">(edited)</span>' : ''}</strong>
                        <div style="font-size: 0.8rem; color: #718096; margin-top: 4px; word-break:break-all;">
                            ${sq.query.substring(0, 100)}${sq.query.length > 100 ? '...' : ''}
                        </div>
                    </div>
                    <div class="selected-query-item-actions">
                        <button class="edit-btn" title="Edit Selected Query" onclick="openEditModal(${index}, 'selected')">
                            <i data-lucide="edit" style="width:14px; height:14px;"></i>
                        </button>
                        <button class="remove-query" title="Remove Query" onclick="removeQuery(${index})">
                            <i data-lucide="x" style="width:14px; height:14px;"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons(); // Initialize Lucide icons for action buttons
        }

        /**
         * Removes a query from the `selectedQueries` array based on its index.
         * @param {number} selectedIndex - The index of the query to remove from `selectedQueries`.
         */
        function removeQuery(selectedIndex) {
            selectedQueries.splice(selectedIndex, 1);
            updateSelectedQueriesDisplay();
            syncPredefinedCardsSelectionState(); // Update predefined card visuals
        }

        /**
         * Opens the edit modal, populating it with the details of the query to be edited.
         * @param {number} index - The index of the query in its respective array (`predefinedQueries` or `selectedQueries`).
         * @param {string} source - Indicates whether the query is 'predefined' or 'selected'.
         */
        function openEditModal(index, source) {
            const modal = document.getElementById('editQueryModal');
            const titleInput = document.getElementById('editQueryTitleInput');
            const textInput = document.getElementById('editQueryTextInput');
            const indexInput = document.getElementById('editQueryIndexInput');
            const sourceInput = document.getElementById('editQuerySourceInput');
            
            let queryToEdit;
            if (source === 'predefined') {
                queryToEdit = predefinedQueries[index];
                document.getElementById('editModalTitle').innerHTML = '<i data-lucide="edit-2" style="margin-right: 8px;"></i>Edit Predefined Template';
            } else { // 'selected'
                queryToEdit = selectedQueries[index];
                 document.getElementById('editModalTitle').innerHTML = '<i data-lucide="edit-2" style="margin-right: 8px;"></i>Edit Selected Query';
            }

            titleInput.value = queryToEdit.title;
            textInput.value = queryToEdit.query;
            indexInput.value = index;
            sourceInput.value = source;
            
            modal.style.display = 'flex'; // Use flex for centering the modal
            lucide.createIcons(); // For icon in modal title
        }

        /**
         * Closes the edit modal.
         */
        function closeEditModal() {
            document.getElementById('editQueryModal').style.display = 'none';
        }

        /**
         * Saves the changes made in the edit modal to the corresponding query.
         * Handles updates for both predefined and selected queries.
         */
        function saveEditedQuery() {
            const newTitle = document.getElementById('editQueryTitleInput').value.trim();
            const newQueryText = document.getElementById('editQueryTextInput').value.trim();
            const index = parseInt(document.getElementById('editQueryIndexInput').value);
            const source = document.getElementById('editQuerySourceInput').value;

            if (!newTitle || !newQueryText) {
                // Use a custom message box instead of alert
                showMessageBox('Title and Query text cannot be empty.', 'Error');
                return;
            }

            if (source === 'predefined') {
                const pqToUpdate = predefinedQueries[index];
                const oldOriginalTitle = pqToUpdate.title; // Store the title before this edit

                pqToUpdate.title = newTitle;
                pqToUpdate.query = newQueryText;

                // If a predefined query is edited, update any selected queries that were clean instances
                // of this predefined query (i.e., not custom edits themselves).
                selectedQueries.forEach(sq => {
                    if (sq.predefinedOriginalTitle === oldOriginalTitle && !sq.isCustom) {
                        sq.title = newTitle; // Update title to match new predefined title
                        sq.query = newQueryText; // Update query
                        sq.predefinedOriginalTitle = newTitle; // Update link to the (now modified) template
                    }
                });
                renderPredefinedQueries(); // Re-render cards to reflect changes
            } else { // 'selected'
                const sqToUpdate = selectedQueries[index];
                sqToUpdate.title = newTitle;
                sqToUpdate.query = newQueryText;
                sqToUpdate.isCustom = true; // Mark as custom, detaching from further auto-updates from template
            }

            updateSelectedQueriesDisplay(); // Refresh selected queries list
            syncPredefinedCardsSelectionState(); // Ensure card selection states are correct
            closeEditModal(); // Close the modal
        }

        /**
         * Sets the active time period for the search.
         * Manages the active button state and visibility of custom date inputs.
         * @param {HTMLElement} element - The button element that was clicked.
         * @param {string} period - The selected period ('24h', 'week', 'month', etc., or 'custom').
         */
        function setPeriod(element, period) {
            selectedPeriod = period;
            document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
            if (element) element.classList.add('active');
            
            const customInputs = document.getElementById('customDateInputs');
            if (period === 'custom') {
                customInputs.style.display = 'grid';
                // If custom dates are empty, set defaults
                if (!document.getElementById('fromDate').value || !document.getElementById('toDate').value) {
                    setDefaultCustomDates();
                }
            } else {
                customInputs.style.display = 'none';
            }
        }

        /**
         * Sets the default 'From Date' to one month ago and 'To Date' to today for custom range.
         */
        function setDefaultCustomDates() {
            const toDateElem = document.getElementById('toDate');
            const fromDateElem = document.getElementById('fromDate');
            const today = new Date();
            
            toDateElem.valueAsDate = today;
            
            const oneMonthAgo = new Date(today);
            oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
            fromDateElem.valueAsDate = oneMonthAgo;
        }

        /**
         * Calculates and returns the date range object based on the selected period.
         * @returns {object|null} An object with `from` and `to` dates formatted for Google search, or `null` if invalid.
         */
        function getDateRange() {
            const today = new Date();
            let fromDate, toDate;
            
            if (selectedPeriod === 'custom') {
                const fromInput = document.getElementById('fromDate').value;
                const toInput = document.getElementById('toDate').value;
                if (!fromInput || !toInput) {
                    // Use a custom message box instead of alert
                    showMessageBox('Please select both from and to dates for custom range', 'Warning');
                    return null;
                }
                fromDate = new Date(fromInput);
                toDate = new Date(toInput);
                toDate.setHours(23, 59, 59, 999); // Include the whole 'to' day

            } else {
                toDate = new Date(today);
                toDate.setHours(23, 59, 59, 999); // Set to end of today

                const from = new Date(today);
                from.setHours(0,0,0,0); // Set to beginning of today
                
                switch (selectedPeriod) {
                    case '24h': from.setDate(from.getDate() - 1); break;
                    case 'week': from.setDate(from.getDate() - 7); break;
                    case 'month': from.setMonth(from.getMonth() - 1); break;
                    case '3months': from.setMonth(from.getMonth() - 3); break;
                    case '6months': from.setMonth(from.getMonth() - 6); break;
                    case 'year': from.setFullYear(from.getFullYear() - 1); break;
                }
                fromDate = from;
            }
            
            if (fromDate > toDate) {
                // Use a custom message box instead of alert
                showMessageBox('From date cannot be after To date.', 'Error');
                return null;
            }

            // Formats date as M/D/YYYY for Google News search
            const formatDateForGoogle = (date) => `${date.getMonth() + 1}/${date.getDate()}/${date.getFullYear()}`;
            return { from: formatDateForGoogle(fromDate), to: formatDateForGoogle(toDate) };
        }

        /**
         * Executes the Google News search with the combined selected queries and chosen date range.
         * Opens the search results in a new tab.
         */
        function executeSearch() {
            if (selectedQueries.length === 0) {
                // Use a custom message box instead of alert
                showMessageBox('Please select at least one query to search', 'Warning');
                return;
            }
            const dateRange = getDateRange();
            if (!dateRange) return; // If date range is invalid, stop execution

            // Combine all selected queries with 'OR' operator
            const combinedQuery = selectedQueries.map(q => q.query).join(' OR '); 
            
            // Construct URL parameters for Google News search
            const params = new URLSearchParams({
                q: combinedQuery, // The search query
                tbm: 'nws', // Specifies Google News search
                num: '100', // Request up to 100 results (Google might return fewer)
                tbs: `cdr:1,cd_min:${dateRange.from},cd_max:${dateRange.to}` // Custom date range
            });
            
            // Open the constructed URL in a new tab
            window.open(`https://www.google.com/search?${params.toString()}`, '_blank');
        }

        /**
         * Displays a custom message box instead of native alert.
         * @param {string} message - The message to display.
         * @param {string} type - The type of message (e.g., 'Warning', 'Error', 'Info').
         */
        function showMessageBox(message, type) {
            // Create modal elements
            const modalOverlay = document.createElement('div');
            modalOverlay.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background-color: rgba(0,0,0,0.6); display: flex;
                justify-content: center; align-items: center; z-index: 1001;
                opacity: 0; transition: opacity 0.3s ease;
            `;

            const messageBox = document.createElement('div');
            messageBox.style.cssText = `
                background-color: white; padding: 30px; border-radius: 12px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2); max-width: 400px;
                text-align: center; transform: translateY(-20px); opacity: 0;
                transition: all 0.3s ease;
            `;

            const iconSpan = document.createElement('span');
            iconSpan.style.cssText = `
                font-size: 3rem; margin-bottom: 15px; display: block;
            `;
            let icon = '';
            let iconColor = '';
            if (type === 'Warning') {
                icon = '⚠️';
                iconColor = '#ffc107';
            } else if (type === 'Error') {
                icon = '❌';
                iconColor = '#dc3545';
            } else {
                icon = 'ℹ️';
                iconColor = '#007bff';
            }
            iconSpan.textContent = icon;
            iconSpan.style.color = iconColor;

            const messageText = document.createElement('p');
            messageText.textContent = message;
            messageText.style.cssText = `
                font-size: 1.1rem; color: #333; margin-bottom: 25px;
            `;

            const closeButton = document.createElement('button');
            closeButton.textContent = 'OK';
            closeButton.style.cssText = `
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white; border: none; padding: 10px 25px; border-radius: 8px;
                font-size: 1rem; cursor: pointer; transition: all 0.2s ease;
            `;
            closeButton.onmouseover = () => closeButton.style.transform = 'translateY(-2px)';
            closeButton.onmouseout = () => closeButton.style.transform = 'translateY(0)';
            closeButton.onclick = () => {
                modalOverlay.style.opacity = '0';
                messageBox.style.transform = 'translateY(-20px)';
                messageBox.style.opacity = '0';
                setTimeout(() => document.body.removeChild(modalOverlay), 300);
            };

            messageBox.appendChild(iconSpan);
            messageBox.appendChild(messageText);
            messageBox.appendChild(closeButton);
            modalOverlay.appendChild(messageBox);
            document.body.appendChild(modalOverlay);

            // Animate in
            setTimeout(() => {
                modalOverlay.style.opacity = '1';
                messageBox.style.transform = 'translateY(0)';
                messageBox.style.opacity = '1';
            }, 10);
        }

        // Event listener for when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            renderPredefinedQueries(); // Initial render of predefined queries
            
            // Set initial active period button (find 'month' and activate)
            const monthButton = Array.from(document.querySelectorAll('.period-btn')).find(btn => btn.getAttribute('onclick').includes("'month'"));
            if (monthButton) setPeriod(monthButton, 'month'); else setPeriod(document.querySelector('.period-btn'), '24h'); // Fallback to 24h if month not found
            
            setDefaultCustomDates(); // Set default dates for custom range inputs
            updateSelectedQueriesDisplay(); // Initial display update for selected queries
            lucide.createIcons(); // Initialize Lucide icons across the page
        });
    </script>

</body>
</html>
